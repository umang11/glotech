steal("jquery/controller",function($){$.Controller("CE.Shortcode",{listensTo:["render"],preloaderClass:"motopress-small-preload"},{shortcode:null,child:null,init:function(el,args){this.shortcode=el.find(".motopress-block-content > [data-motopress-shortcode]");this.child=this.shortcode.children("div")},renderShortcode:function(isNew){isNew=(typeof isNew==="undefined"||!isNew)?false:true;var $this=this;var handle=this.element.find(".motopress-drag-handle");handle.addClass(CE.Shortcode.preloaderClass);var closeType=this.shortcode.attr("data-motopress-close-type");var shortcode=this.shortcode.attr("data-motopress-shortcode");var group=this.shortcode.attr("data-motopress-group");var wrapRender=(typeof this.shortcode.attr("data-motopress-wrap-render")!=="undefined")?this.shortcode.attr("data-motopress-wrap-render"):null;var parameters=(typeof this.shortcode.attr("data-motopress-parameters")!=="undefined")?this.shortcode.attr("data-motopress-parameters"):null;var styles=(typeof this.shortcode.attr("data-motopress-styles")!=="undefined")?this.shortcode.attr("data-motopress-styles"):null;if(isNew&&parameters){parameters=this.setDefaultAttrs(parameters)}if(isNew&&styles){styles=this.setDefaultStyle(styles)}var content=(typeof this.shortcode.attr("data-motopress-content")!=="undefined")?this.shortcode.attr("data-motopress-content").replace(/\[\]/g,"["):null;if(typeof this.shortcode.attr("data-motopress-active-item")!=="undefined"){var JSONParameters=$.parseJSON(parameters);JSONParameters.active={value:this.shortcode.attr("data-motopress-active-item")};parameters=JSON.stringify(JSONParameters)}$.ajax({url:parent.motopress.ajaxUrl,type:"POST",dataType:"html",data:{action:"motopress_ce_render_shortcode",nonce:parent.motopressCE.nonces.motopress_ce_render_shortcode,postID:parent.motopressCE.postID,closeType:closeType,shortcode:shortcode,wrapRender:wrapRender,parameters:parameters,styles:styles,content:content},success:function(data){var span=$this.shortcode.closest('[class*="span"].motopress-span');if(!span.parent(".motopress-content-wrapper > .mp-row-fluid.motopress-row").length){var handleMiddleLast=span.parent(".mp-row-fluid.motopress-row").nextAll(".motopress-handle-middle-in:last");var minHeight=parseInt(handleMiddleLast.css("min-height"));handleMiddleLast.height(minHeight)}$(".motopress-content-wrapper > .motopress-handle-middle-in:last").height("");$this.shortcode.html(data);$this.child=$this.shortcode.children("div");var images=$this.shortcode.find("img");var imgCount=images.length,count=0;if(imgCount){images.on("load",function(){count++;if(count===imgCount){$this.element.trigger("render")}})}if(isNew){switch(shortcode){case"mp_tabs":$this.settingsForms.find('> [data-motopress-parameter="tabs"] > .motopress-property-group > .motopress-property-button-wrapper > .motopress-property-button-default').trigger("click",CE.LeftBar.myThis.library[group].objects[shortcode].parameters.tabs.items.count);break;case"mp_accordion":$this.settingsForms.find('> [data-motopress-parameter="accordionItems"] > .motopress-property-group > .motopress-property-button-wrapper > .motopress-property-button-default').trigger("click",CE.LeftBar.myThis.library[group].objects[shortcode].parameters.accordionItems.items.count);break}}$this.element.trigger("render");handle.removeClass(CE.Shortcode.preloaderClass);parent.CE.Save.changeContent()},error:function(jqXHR){var error=$.parseJSON(jqXHR.responseText);if(error.debug){console.log(error.message)}else{parent.MP.Flash.setFlash(error.message,"error");parent.MP.Flash.showMessage()}handle.removeClass(CE.Shortcode.preloaderClass)}})},setDefaultAttrs:function(parameters,childShortcode){var JSONParameters=$.parseJSON(parameters);var generalAttrs=this.getGeneralAttrs(childShortcode);var $this=this;$.each(JSONParameters,function(name,values){if(typeof values.value==="undefined"||!values.value){if(typeof childShortcode!=="undefined"&&childShortcode.attr("data-motopress-shortcode")==="mp_tab"&&name==="id"){values.value=parent.MP.Utils.uniqid()}else{if(generalAttrs[name].hasOwnProperty("saveInContent")&&generalAttrs[name].saveInContent==="true"){var shortcode=(typeof childShortcode==="undefined")?$this.shortcode:childShortcode;shortcode.attr("data-motopress-content",generalAttrs[name]["default"])}else{values.value=generalAttrs[name]["default"]}}}});this.setShortcodeAttrs(JSONParameters,childShortcode);return JSON.stringify(JSONParameters)},setDefaultStyle:function(style){var JSONStyle=$.parseJSON(style);$.each(JSONStyle,function(name,values){if(typeof values.value==="undefined"||!values.value){var defaultVal=CE.Style.props[name]["default"];if(name==="margin"){defaultVal=defaultVal.join(",")}values.value=defaultVal}});this.setShortcodeStyle(JSONStyle);return JSON.stringify(JSONStyle)}})});